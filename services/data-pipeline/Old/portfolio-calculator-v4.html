<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfolio Return Calculator ‚Äî Clean UI</title>
  <style>
    /* ---------- Design Tokens ---------- */
    :root {
      --bg: #0b0c10;
      --panel: #0f1115;
      --panel-2: #131620;
      --text: #e6e8ee;
      --muted: #9aa3b2;
      --brand: #7c8cff; /* indigo-ish */
      --brand-2: #9a6bff; /* violet-ish */
      --accent: #2dd4bf; /* teal */
      --red: #fda4af;
      --green: #86efac;
      --ring: #94a3b8;
      --radius: 14px;
      --shadow: 0 8px 30px rgba(0,0,0,.45);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f6f7fb;
        --panel: #ffffff;
        --panel-2: #f6f7fb;
        --text: #0f172a;
        --muted: #6b7280;
        --ring: #cbd5e1;
        --shadow: 0 10px 28px rgba(17,24,39, .08);
      }
    }

    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(124,140,255,.14), transparent 40%),
                  radial-gradient(1200px 800px at 120% 10%, rgba(154,107,255,.12), transparent 40%),
                  var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: clamp(12px, 2vw, 24px);
    }

    .shell {
      max-width: 980px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }
    .title {
      font-size: clamp(22px, 2.2vw, 28px);
      font-weight: 800;
      letter-spacing: -.02em;
    }
    .subtitle {
      color: var(--muted);
      font-size: 13px;
    }

    /* Panel */
    .panel {
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(148,163,184,.18);
      overflow: hidden;
    }

    /* Config grid */
    .config {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      padding: 18px;
      border-bottom: 1px dashed rgba(148,163,184,.24);
    }
    .field { grid-column: span 4; min-width: 0; }
    .label { font-size: 11px; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); margin-bottom: 6px; }
    .input, .select {
      width: 100%;
      height: 40px;
      border-radius: 10px;
      background: rgba(148,163,184,.10);
      border: 1px solid rgba(148,163,184,.28);
      padding: 0 12px;
      color: var(--text);
      outline: none;
      transition: box-shadow .2s, border-color .2s, background .2s;
    }
    .input:focus, .select:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 4px rgba(124,140,255,.18);
      background: rgba(148,163,184,.16);
    }

    @media (max-width: 820px){ .field { grid-column: span 12 } }

    /* Sliders */
    .sliders { padding: 6px 18px 18px; display: grid; gap: 10px; }
    .row {
      display: grid;
      grid-template-columns: 220px 1fr 76px;
      align-items: center;
      gap: 14px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(148,163,184,.10);
      border: 1px solid rgba(148,163,184,.22);
    }
    .row:hover { border-color: rgba(124,140,255,.5) }

    .asset { font-weight: 700; letter-spacing: .01em; }
    .value { text-align: right; font-variant-numeric: tabular-nums; font-weight: 800; }

    input[type="range"].slider {
      appearance: none; -webkit-appearance: none; width: 100%; height: 8px; border-radius: 999px; outline: none;
      background: linear-gradient(90deg, var(--brand) var(--fill, 0%), rgba(148,163,184,.32) var(--fill, 0%));
    }
    /* Track (Firefox) */
    .slider::-moz-range-track { height: 8px; border-radius: 999px; background: transparent; }
    /* Thumb */
    .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; border-radius: 50%;
      background: conic-gradient(from 180deg at 50% 50%, var(--brand), var(--brand-2)); border: 2px solid #fff1; box-shadow: 0 2px 12px rgba(0,0,0,.35);
      transition: transform .08s ease;
    }
    .slider::-moz-range-thumb { width: 22px; height: 22px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), var(--brand-2)); border: 2px solid #fff1; box-shadow: 0 2px 12px rgba(0,0,0,.35); }
    .slider:active::-webkit-slider-thumb { transform: scale(1.08) }
    .slider:focus-visible { outline: none; box-shadow: 0 0 0 4px rgba(124,140,255,.24) }

    /* Total */
    .totalbar {
      display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 12px 18px; border-top: 1px dashed rgba(148,163,184,.24); background: linear-gradient(180deg, rgba(148,163,184,.12), rgba(148,163,184,.04));
    }
    .chip { font-size: 12px; font-weight: 700; letter-spacing: .04em; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(148,163,184,.34); background: rgba(148,163,184,.14); }
    .chip.ok { color: #065f46; background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.35); }
    .chip.bad { color: #7f1d1d; background: rgba(244,63,94,.20); border-color: rgba(244,63,94,.35); }

    /* Actions */
    .actions { padding: 16px 18px; display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .btn {
      height: 44px; border-radius: 12px; border: 1px solid transparent; font-weight: 800; letter-spacing: .02em; cursor: pointer;
      background: linear-gradient(180deg, var(--brand), var(--brand-2)); color: white; box-shadow: 0 8px 18px rgba(124,140,255,.25);
      transition: transform .12s ease, box-shadow .12s ease, opacity .2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 26px rgba(124,140,255,.32) }
    .btn:disabled { opacity: .55; cursor: not-allowed; box-shadow: none }
    .btn.secondary { background: transparent; color: var(--text); border: 1px solid rgba(148,163,184,.32) }
    .btn.secondary:hover { border-color: rgba(148,163,184,.6) }

    /* Results */
    .results { padding: 18px; display: none }
    .results.visible { display: block }
    .grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 14px;
    }
    .card {
      border-radius: 14px; padding: 16px; color: white; background: linear-gradient(135deg, var(--brand), var(--brand-2)); box-shadow: 0 8px 22px rgba(124,140,255,.25);
    }
    .label { font-size: 11px; text-transform: uppercase; opacity: .9; letter-spacing: .06em; }
    .value { font-size: 26px; font-weight: 900; margin-top: 6px; }

    /* Error + Loading */
    .error { display: none; margin: 12px 18px 0; padding: 12px; border-radius: 12px; border: 1px solid rgba(239,68,68,.35); color: #fee2e2; background: linear-gradient(180deg, rgba(239,68,68,.16), rgba(239,68,68,.06)); font-family: var(--mono); white-space: pre-wrap }
    .error.visible { display: block }

    .loading { display: none; text-align: center; padding: 18px; color: var(--muted) }
    .loading.visible { display: block }
    .spinner{ width: 36px; height: 36px; border-radius: 50%; border: 3px solid rgba(148,163,184,.35); border-top-color: var(--brand); margin: 0 auto 8px; animation: spin 1s linear infinite }
    @keyframes spin { to { transform: rotate(360deg) } }

    /* Debug */
    details.debug { border-top: 1px dashed rgba(148,163,184,.24); padding: 10px 18px 18px }
    details.debug pre { background: #0b1020; color: #e2e8f0; border: 1px solid rgba(148,163,184,.24); border-radius: 10px; padding: 12px; overflow: auto; box-shadow: inset 0 1px 0 rgba(255,255,255,.02) }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div>
        <div class="title">Portfolio Return Calculator</div>
        <div class="subtitle">Tweak allocations with crisp sliders. Total must equal 100%. Monthly returns; optional rebalancing.</div>
      </div>
    </div>

    <section class="panel" id="app">
      <!-- Config -->
      <div class="config">
        <div class="field">
          <div class="label">Start Date</div>
          <input class="input" type="month" id="start-date" value="2020-01" />
        </div>
        <div class="field">
          <div class="label">End Date</div>
          <input class="input" type="month" id="end-date" value="2023-12" />
        </div>
        <div class="field">
          <div class="label">Rebalance</div>
          <select class="select" id="rebalance-freq">
            <option value="-1" selected>Never</option>
            <option value="12">Annually</option>
            <option value="3">Quarterly</option>
            <option value="1">Monthly</option>
          </select>
        </div>
      </div>

      <!-- Sliders -->
      <div class="sliders">
        <div class="row">
          <div class="asset">S&P 500 (SPY)</div>
          <input type="range" min="0" max="100" value="60" class="slider" id="slider-0" data-asset="SPY" />
          <div class="value"><span id="value-0">60</span>%</div>
        </div>
        <div class="row">
          <div class="asset">Technology (QQQ)</div>
          <input type="range" min="0" max="100" value="0" class="slider" id="slider-1" data-asset="QQQ" />
          <div class="value"><span id="value-1">0</span>%</div>
        </div>
        <div class="row">
          <div class="asset">Bonds (AGG)</div>
          <input type="range" min="0" max="100" value="40" class="slider" id="slider-2" data-asset="AGG" />
          <div class="value"><span id="value-2">40</span>%</div>
        </div>
        <div class="row">
          <div class="asset">Gold (GLD)</div>
          <input type="range" min="0" max="100" value="0" class="slider" id="slider-3" data-asset="GLD" />
          <div class="value"><span id="value-3">0</span>%</div>
        </div>
        <div class="row">
          <div class="asset">US Total Market (VTI)</div>
          <input type="range" min="0" max="100" value="0" class="slider" id="slider-4" data-asset="VTI" />
          <div class="value"><span id="value-4">0</span>%</div>
        </div>
        <div class="row">
          <div class="asset">Total Bond Market (BND)</div>
          <input type="range" min="0" max="100" value="0" class="slider" id="slider-5" data-asset="BND" />
          <div class="value"><span id="value-5">0</span>%</div>
        </div>
        <div class="row">
          <div class="asset">Emerging Markets (EEM)</div>
          <input type="range" min="0" max="100" value="0" class="slider" id="slider-6" data-asset="EEM" />
          <div class="value"><span id="value-6">0</span>%</div>
        </div>
      </div>

      <!-- Total and actions -->
      <div class="totalbar">
        <div class="subtitle">Total Allocation</div>
        <div class="chip" id="total-chip"><strong><span id="total-value">100</span>%</strong></div>
      </div>
      <div class="actions">
        <button class="btn secondary" id="force-btn" type="button">‚ö° Force to 100%</button>
        <button class="btn" id="calculate-btn" type="button">Calculate Portfolio Returns</button>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Calculating returns‚Ä¶</div>
      </div>
      <div class="error" id="error-message"></div>

      <section class="results" id="results-section">
        <div class="grid">
          <div class="card"><div class="label">Total Return</div><div class="value" id="total-return">--</div></div>
          <div class="card"><div class="label">Annualized Return</div><div class="value" id="annualized-return">--</div></div>
          <div class="card"><div class="label">Volatility</div><div class="value" id="volatility">--</div></div>
          <div class="card"><div class="label">Time Period</div><div class="value" id="time-period">--</div></div>
        </div>
      </section>

      <details class="debug">
        <summary>üîç Debug: Function Arguments</summary>
        <pre id="debug-output">No calculation performed yet</pre>
      </details>
    </section>
  </div>

  <script>
    // Keep the user's original logic but with small enhancements for slider fill + focus
    const sliders = document.querySelectorAll('.slider');
    const totalChip = document.getElementById('total-chip');
    const totalValue = document.getElementById('total-value');
    const calculateBtn = document.getElementById('calculate-btn');
    const forceBtn = document.getElementById('force-btn');

    const setSliderFill = (el) => {
      const pct = Number(el.value);
      el.style.setProperty('--fill', pct + '%');
    };

    function updateSliderDisplay(sliderId, value) {
      document.getElementById(`value-${sliderId}`).textContent = value;
    }

    function updateTotal() {
      let total = 0;
      sliders.forEach((s) => total += parseInt(s.value, 10));
      totalValue.textContent = total;

      // visual state
      totalChip.classList.remove('ok', 'bad');
      if (total === 100) {
        totalChip.classList.add('ok');
        calculateBtn.disabled = false;
      } else {
        totalChip.classList.add('bad');
        calculateBtn.disabled = true;
      }
      return total;
    }

    sliders.forEach((slider, index) => {
      setSliderFill(slider);
      slider.addEventListener('input', (e) => {
        setSliderFill(slider);
        updateSliderDisplay(index, e.target.value);
        updateTotal();
      });
      slider.addEventListener('focus', () => slider.parentElement.style.outline = '2px solid rgba(124,140,255,.35)');
      slider.addEventListener('blur', () => slider.parentElement.style.outline = 'none');
    });
    updateTotal();

    function forceTo100() {
      let currentTotal = 0;
      sliders.forEach((s) => currentTotal += parseInt(s.value, 10));

      if (currentTotal === 0) {
        const equal = Math.floor(100 / sliders.length);
        const rem = 100 - (equal * sliders.length);
        sliders.forEach((s, i) => { const v = i === 0 ? equal + rem : equal; s.value = v; setSliderFill(s); });
      } else {
        const scale = 100 / currentTotal;
        let running = 0;
        sliders.forEach((s, i) => {
          let nv;
          if (i === sliders.length - 1) { nv = 100 - running; }
          else { nv = Math.round(parseInt(s.value, 10) * scale); running += nv; }
          s.value = nv; setSliderFill(s);
        });
      }
      sliders.forEach((s, i) => updateSliderDisplay(i, s.value));
      updateTotal();
    }

    forceBtn.addEventListener('click', forceTo100);

    function updateDebugOutput(requestBody) {
      const debugEl = document.getElementById('debug-output');
      const formatted = JSON.stringify(requestBody, null, 2)
        .replace(/"([^\"]+)":/g, '<span style="color:#a5b4fc">"$1"</span>:')
        .replace(/: "([^\"]+)"/g, ': <span style="color:#f9a8d4">"$1"</span>')
        .replace(/: (\d+\.?\d*)/g, ': <span style="color:#93c5fd">$1</span>');
      debugEl.innerHTML = `<strong>Request Body:</strong>\n${formatted}`;
    }

    async function calculateReturns() {
      const apiEndpoint = 'https://investment-chatbot-1.vercel.app/api/portfolio/calculate';
      const startDate = document.getElementById('start-date').value + '-01';
      const [y, m] = document.getElementById('end-date').value.split('-');
      const lastDay = new Date(y, m, 0).getDate();
      const endDate = `${y}-${m}-${String(lastDay).padStart(2,'0')}`;
      const rebalanceMonths = parseInt(document.getElementById('rebalance-freq').value, 10);

      const assets = []; const weights = [];
      sliders.forEach((s) => { assets.push(s.dataset.asset); weights.push(parseInt(s.value,10)/100); });

      const requestBody = { assets, weights, startDate, endDate, rebalanceMonths };
      updateDebugOutput(requestBody);

      document.getElementById('loading').classList.add('visible');
      document.getElementById('error-message').classList.remove('visible');
      document.getElementById('results-section').classList.remove('visible');
      calculateBtn.disabled = true;

      try {
        const res = await fetch(apiEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody), mode: 'cors' });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || `HTTP ${res.status}: Failed to calculate returns`);
        displayResults(data);
      } catch (err) {
        let msg = err.message;
        if (msg === 'Failed to fetch') {
          msg = 'Network error. Possible causes:\n‚Ä¢ CORS restrictions (host this file on a web server)\n‚Ä¢ API endpoint unreachable\n‚Ä¢ Connectivity issues';
        }
        showError(msg);
      } finally {
        document.getElementById('loading').classList.remove('visible');
        calculateBtn.disabled = false;
      }
    }

    function displayResults(data) {
      const r = data.results;
      document.getElementById('total-return').textContent = r.totalReturnPercent.toFixed(2) + '%';
      document.getElementById('annualized-return').textContent = r.annualizedReturnPercent.toFixed(2) + '%';
      document.getElementById('volatility').textContent = r.volatilityPercent.toFixed(2) + '%';
      document.getElementById('time-period').textContent = r.numYears.toFixed(1) + ' yrs';
      document.getElementById('results-section').classList.add('visible');
    }

    function showError(message) {
      const el = document.getElementById('error-message');
      el.textContent = '‚ùå ' + message;
      el.classList.add('visible');
    }

    // Hook up calculate button
    calculateBtn.addEventListener('click', calculateReturns);
  </script>
</body>
</html>

